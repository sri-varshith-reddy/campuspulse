<% layout("/layouts/boilerplate") %>

<style>
  body {
    background: linear-gradient(to bottom, #fff8e1, #ffffff 20%);
  }
</style>

<body>
  <div class="container show-container">
    <div class="row">
      <!-- HERO -->
      <div class="col-md-8">
        <div class="hero-wrap">
          <img src="<%= item.image.url %>" alt="Event image">
        </div>
      </div>

      <!-- SIDE PANEL -->
      <div class="col-md-4">
        <div class="info-panel">
          <div class="info-title"><%= item.title %></div>

          <div class="info-category">
            <i class="far fa-bookmark"></i>
            <%= item.category || "Comedy, Standup" %>
          </div>

          <div class="info-line">
            <i class="far fa-calendar-alt"></i>
            <%= item.startDate.toLocaleString("en-GB",{day:"numeric",month:"short"}) %>
            –
            <%= item.endDate.toLocaleString("en-GB",{day:"numeric",month:"short"}) %>
            |
            <%= item.startDate.toLocaleString("en-GB",{hour:"2-digit",minute:"2-digit"}) %> onwards
          </div>

          <div class="info-line">
            <i class="fas fa-map-marker-alt"></i>
            <%= item.location %>, <%= item.country %>
          </div>

          <hr>

          <div class="info-price-label">Starts from</div>
          <div class="info-price">₹<%= item.price.toLocaleString("en-IN") %></div>

          <div class="spacer"></div>

          <% if (currUser) {
               const attendees = Array.isArray(item.attendees) ? item.attendees : [];
               const booked = attendees
                 .map(a => (a._id||a).toString())
                 .includes(currUser._id.toString());
          %>
            <form action="/listing/<%= item._id %>/book" method="POST">
              <button class="btn-book" <%= booked ? 'disabled' : '' %>>
                <%= booked ? 'Booked ✔' : 'Book Tickets' %>
              </button>
            </form>
            <% if (item.attendees && item.attendees.length > 0) { %>
              <div style="font-size: 0.85rem; color: #555; text-align: center;">
                <%= item.attendees.length %> Attendee<%= item.attendees.length === 1 ? '' : 's' %> Going
              </div>
            <% } %>
          <% } else { %>
            <a href="/login">
              <button class="btn-book">Login to Book</button>
            </a>
            <% if (item.attendees && item.attendees.length > 0) { %>
              <div style="font-size: 0.85rem; color: #555; text-align: center;">
                <%= item.attendees.length %> Attendee<%= item.attendees.length === 1 ? '' : 's' %> Going
              </div>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>

    <!-- About -->
    <div class="about-header">About the Event</div>
    <div class="description"><%= item.description %></div>

    <% if (currUser && item.owner && currUser._id.equals(item.owner._id)) { %>
      <div class="owner-actions">
        <a href="/listing/<%= item._id %>/edit" class="btn-owner-edit">
          <i class="fas fa-edit"></i> Edit Listing
        </a>
        <form action="/listing/<%= item._id %>?_method=DELETE" method="POST">
          <button type="submit" class="btn-owner-delete">
            <i class="fas fa-trash-alt"></i> Delete Listing
          </button>
        </form>
      </div>
    <% } %>

    <!-- Leave Review -->
    <% if (currUser) { %>
      <div class="leave-header">Leave a Review</div>
      <form action="/listing/<%= item._id %>/review" method="POST" novalidate class="needs-validation" style="max-width:600px;">
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <fieldset class="starability-coinFlip">
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating."/>
            <% [1,2,3,4,5].forEach(i => { %>
              <input type="radio" id="rate<%=i%>" name="review[rating]" value="<%=i%>"/>
              <label for="rate<%=i%>"><%=i%> star</label>
            <% }) %>
          </fieldset>
        </div>

        <div class="mb-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea id="comment" name="review[comment]" rows="4" required class="form-control" placeholder="Share your thoughts about the event..." style="resize: vertical;"></textarea>
          <div class="invalid-feedback">Please submit some comments for review</div>
        </div>

        <button type="submit" class="btn-book" style="max-width: 200px;">Submit Review</button>
      </form>
    <% } %>

    <!-- All Reviews -->
    <% if (item.reviews && item.reviews.length) { %>
      <div class="reviews-header">All Reviews</div>
      <div class="row">
        <% item.reviews.forEach(review => { %>
          <div class="col-md-6">
            <div class="card review-card mb-3">
              <div class="card-body">
                <h5 class="card-title">@<%= review.author.username %></h5>
                <p class="starability-result" data-rating="<%= review.rating %>"><%= review.rating %> / 5</p>
                <p class="card-text"><%= review.comment %></p>
                <form action="/listing/<%= item._id %>/review/<%= review._id %>?_method=DELETE" method="POST">
                  <button type="submit" style="background:none;border:none;color:#555;font-size:.85rem;">Delete</button>
                </form>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</body>
